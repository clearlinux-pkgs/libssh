Backport of:

From fcfba0d8aa15a0142e57513f271eb7fa4bbabc9a Mon Sep 17 00:00:00 2001
From: Anderson Toshiyuki Sasaki <ansasaki@redhat.com>
Date: Mon, 10 Sep 2018 17:38:22 +0200
Subject: CVE-2018-10933: Introduce SSH_AUTH_STATE_PASSWORD_AUTH_SENT

The introduced auth state allows to identify when authentication using
password was tried.

Fixes T101

Signed-off-by: Anderson Toshiyuki Sasaki <ansasaki@redhat.com>
Reviewed-by: Andreas Schneider <asn@cryptomilk.org>
---
 include/libssh/auth.h | 2 ++
 src/auth.c            | 4 +++-
 2 files changed, 5 insertions(+), 1 deletion(-)

Index: libssh-0.8.0~20170825.94fa1e38/include/libssh/auth.h
===================================================================
--- libssh-0.8.0~20170825.94fa1e38.orig/include/libssh/auth.h	2018-10-16 14:21:25.582561097 -0400
+++ libssh-0.8.0~20170825.94fa1e38/include/libssh/auth.h	2018-10-16 14:21:25.582561097 -0400
@@ -94,6 +94,8 @@ enum ssh_auth_state_e {
   SSH_AUTH_STATE_PUBKEY_OFFER_SENT,
   /** We have sent pubkey and signature expecting to be authenticated */
   SSH_AUTH_STATE_PUBKEY_AUTH_SENT,
+  /** We have sent a password expecting to be authenticated */
+  SSH_AUTH_STATE_PASSWORD_AUTH_SENT,
 };
 
 /** @internal
Index: libssh-0.8.0~20170825.94fa1e38/src/auth.c
===================================================================
--- libssh-0.8.0~20170825.94fa1e38.orig/src/auth.c	2018-10-16 14:21:25.582561097 -0400
+++ libssh-0.8.0~20170825.94fa1e38/src/auth.c	2018-10-16 14:21:44.002710814 -0400
@@ -87,6 +87,7 @@ static int ssh_auth_response_termination
     case SSH_AUTH_STATE_GSSAPI_MIC_SENT:
     case SSH_AUTH_STATE_PUBKEY_AUTH_SENT:
     case SSH_AUTH_STATE_PUBKEY_OFFER_SENT:
+    case SSH_AUTH_STATE_PASSWORD_AUTH_SENT:
       return 0;
     default:
       return 1;
@@ -141,6 +142,7 @@ static int ssh_userauth_get_response(ssh
         case SSH_AUTH_STATE_GSSAPI_MIC_SENT:
         case SSH_AUTH_STATE_PUBKEY_OFFER_SENT:
         case SSH_AUTH_STATE_PUBKEY_AUTH_SENT:
+        case SSH_AUTH_STATE_PASSWORD_AUTH_SENT:
         case SSH_AUTH_STATE_NONE:
             /* not reached */
             rc = SSH_AUTH_ERROR;
@@ -1178,7 +1180,7 @@ int ssh_userauth_password(ssh_session se
         goto fail;
     }
 
-    session->auth_state = SSH_AUTH_STATE_NONE;
+    session->auth_state = SSH_AUTH_STATE_PASSWORD_AUTH_SENT;
     session->pending_call_state = SSH_PENDING_CALL_AUTH_OFFER_PUBKEY;
     rc = ssh_packet_send(session);
     if (rc == SSH_ERROR) {
