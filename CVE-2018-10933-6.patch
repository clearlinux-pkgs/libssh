From f8c452cbef228b105dcb757d7554c3388a4dbea5 Mon Sep 17 00:00:00 2001
From: Anderson Toshiyuki Sasaki <ansasaki@redhat.com>
Date: Fri, 7 Sep 2018 17:12:01 +0200
Subject: CVE-2018-10933: Check channel state when OPEN_FAILURE arrives

When a SSH2_MSG_OPEN_FAILURE arrives, the channel state is checked
to be in SSH_CHANNEL_STATE_OPENING.

Fixes T101

Signed-off-by: Anderson Toshiyuki Sasaki <ansasaki@redhat.com>
Reviewed-by: Andreas Schneider <asn@cryptomilk.org>
---
 src/channels.c | 12 ++++++++++++
 1 file changed, 12 insertions(+)

Index: libssh-0.8.0~20170825.94fa1e38/src/channels.c
===================================================================
--- libssh-0.8.0~20170825.94fa1e38.orig/src/channels.c	2018-10-16 14:23:54.854967945 -0400
+++ libssh-0.8.0~20170825.94fa1e38/src/channels.c	2018-10-16 14:23:54.854967945 -0400
@@ -219,6 +219,14 @@ SSH_PACKET_CALLBACK(ssh_packet_channel_o
       return SSH_PACKET_USED;
   }
 
+  if (channel->state != SSH_CHANNEL_STATE_OPENING) {
+      SSH_LOG(SSH_LOG_RARE,
+              "SSH2_MSG_CHANNEL_OPEN_FAILURE received in incorrect channel "
+              "state %d",
+              channel->state);
+      goto error;
+  }
+
   ssh_set_error(session, SSH_REQUEST_DENIED,
       "Channel opening failure: channel %u error (%lu) %s",
       channel->local_channel,
@@ -227,6 +235,10 @@ SSH_PACKET_CALLBACK(ssh_packet_channel_o
   SAFE_FREE(error);
   channel->state=SSH_CHANNEL_STATE_OPEN_DENIED;
   return SSH_PACKET_USED;
+
+error:
+  ssh_set_error(session, SSH_FATAL, "Invalid packet");
+  return SSH_PACKET_USED;
 }
 
 static int ssh_channel_open_termination(void *c){
